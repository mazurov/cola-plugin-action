name: Test Action

on:
  pull_request:
  push:
    branches: [main]

jobs:
  # Test validation with VALID plugins (should succeed)
  test-validation-valid:
    name: Test Validation (Valid Plugins)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate valid plugins
        uses: ./
        with:
          plugins-directory: 'tests/valid'
          validate-only: 'true'

  # Test validation with INVALID plugins (should fail)
  test-validation-invalid:
    name: Test Validation (Invalid Plugins - Expected Failure)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate invalid plugins (expect failure)
        id: validate-invalid
        continue-on-error: true
        uses: ./
        with:
          plugins-directory: 'tests/invalid'
          validate-only: 'true'

      - name: Check validation failed as expected
        run: |
          if [ "${{ steps.validate-invalid.outcome }}" = "failure" ]; then
            echo "âœ… Validation correctly failed for invalid plugins"
            exit 0
          else
            echo "âŒ Validation should have failed but didn't!"
            exit 1
          fi

  # Test packaging with valid plugins
  test-packaging:
    name: Test Packaging (tar.gz)
    runs-on: ubuntu-latest
    needs: test-validation-valid
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Package valid plugins
        uses: ./
        with:
          plugins-directory: 'tests/valid'
          package-format: 'tar.gz'
          generate-docs: 'false'

      - name: Verify packages were created
        run: |
          echo "ðŸ“¦ Checking for created packages..."
          if [ ! -d "build/packages" ]; then
            echo "âŒ build/packages directory not found"
            exit 1
          fi

          package_count=$(ls -1 build/packages/*.tar.gz 2>/dev/null | wc -l)
          if [ "$package_count" -eq 0 ]; then
            echo "âŒ No tar.gz packages found"
            exit 1
          fi

          echo "âœ… Found $package_count package(s):"
          ls -lh build/packages/*.tar.gz

      - name: Upload test artifacts
        uses: actions/upload-artifact@v4
        with:
          name: test-packages
          path: build/packages/*.tar.gz

  # Test documentation generation from releases
  test-docs:
    name: Test Documentation Generation (From Releases)
    runs-on: ubuntu-latest
    needs: test-validation-valid
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install pandoc for better markdown rendering
        run: sudo apt-get update && sudo apt-get install -y pandoc

      - name: Install yq for manifest parsing
        run: |
          wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          chmod +x /usr/local/bin/yq

      - name: Generate documentation from mock releases
        env:
          PLUGINS_DIR: tests/valid
          SKIP_BROWSER: 1
        run: bash scripts/test-docs-from-releases.sh

      - name: Verify versioned documentation was generated
        run: |
          echo "ðŸ“š Checking for generated versioned documentation..."

          if [ ! -d "build/docs-from-releases" ]; then
            echo "âŒ build/docs-from-releases directory not found"
            exit 1
          fi

          if [ ! -f "build/docs-from-releases/index.html" ]; then
            echo "âŒ Root index.html not found"
            exit 1
          fi

          if [ ! -f "build/docs-from-releases/versions.json" ]; then
            echo "âŒ versions.json not found"
            exit 1
          fi

          # Verify versioned plugin structure
          if [ ! -d "build/docs-from-releases/plugins" ]; then
            echo "âŒ plugins directory not found"
            exit 1
          fi

          # Count versioned plugin pages
          version_count=$(find build/docs-from-releases/plugins -type d -name "v*" 2>/dev/null | wc -l)
          echo "âœ… Found $version_count versioned plugin page(s)"

          # Verify version selectors exist
          selector_count=$(find build/docs-from-releases/plugins -name "index.html" 2>/dev/null | wc -l)
          echo "âœ… Found $selector_count version index page(s)"

          # Display versions.json content
          echo ""
          echo "versions.json content:"
          cat build/docs-from-releases/versions.json

          # List generated structure
          echo ""
          echo "Generated structure:"
          tree -L 4 build/docs-from-releases/ || find build/docs-from-releases/ -type f -name "*.html" | head -20

      - name: Upload documentation artifacts
        uses: actions/upload-artifact@v4
        with:
          name: test-documentation
          path: build/docs-from-releases/
